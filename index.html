<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title></title>
  <!-- <script type='text/javascript' src="lib/d3.js"></script> -->
  <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.5.0"></script>
  <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js?2.5.0"></script>
  <script type='text/javascript' src='src/tooltip.js'></script>

  <link href="style.css" rel="stylesheet"/>
  <style>
    .tooltip {
      font-size: 12px;
    }
    .tooltip_bg {
      fill: white;
      stroke: black;
      stroke-width: 1;
      opacity: 0.85;
    }
  </style>

  <script> 
  var overNode = function () {
    selectedNode = this; 
    //console.log(selectedNode);
  };

  var outNode = function () {
    selectedNode = null;
    //console.log(selectedNode);
  };










    var x0 = 0, y0 = 5;
    var selectedElement = 0;
    var selectedNode = null;
    var currentX = 0;
    var currentY = 0;
    var currentMatrix = 0;

    var sourceX = null;
    var sourceY = null;

    function startHandler(d) {
    startNode = null;
    d3.event.sourceEvent.stopPropagation();
    //d3.select(this).style('cursor', 'move');
    //this.parentNode.appendChild(this);
    endNode = this.id;
    //startX = parseInt(d.x) + parseInt(d3.select(this.cx.animVal.value)) + 15;
    //startY = parseInt(d.y) + parseInt(d3.select(this.cy.animVal.value));
    //linkX = startX;
    //linkY = startY;
    sourceCoords = d3.transform(d3.select(this).attr("transform")).translate;
    sourceX = sourceCoords[0]; //this.x; //d3.select(this).x;
    sourceY = sourceCoords[1]; //d3.select(this).y;
    console.log("source: " + sourceX + "," + sourceY);
    startNode = d3.event.sourceEvent.srcElement.parentNode.id;
    }
    function dropHandler(d) {
    //d3.select(this).style('cursor', "crosshair");
    if (selectedNode) {
      targetCoords = d3.transform(d3.select(selectedNode).attr("transform")).translate;
      d3.select(this).attr("x", targetCoords[0]).attr("y", targetCoords[1])
       .attr("transform", "translate(" + [ targetCoords[0],targetCoords[1] ] + ")");
      d3.select(selectedNode).attr("x", sourceX).attr("y", sourceY)
       .attr("transform", "translate(" + [ sourceX,sourceY ] + ")");

    } else {
      d3.select(this).attr("x", sourceX).attr("y", sourceY)
       .attr("transform", "translate(" + [ sourceX,sourceY ] + ")");
    }
    selectedNode = null;
   }   


 // http://bl.ocks.org/enjalot/1378144
 var drag = d3.behavior.drag()
        .on("drag", function(d,i) {
            d.x += d3.event.dx
            d.y += d3.event.dy
            d3.select(this).attr("transform", function(d,i){
                return "translate(" + [ d.x,d.y ] + ")"
            })
        })
        .on("dragstart", startHandler)
        .on("dragend", dropHandler);

    function displayChromosome(chrFile) {
      d3.select('svg').remove();
      line_objects = [];

      d3.tsv(chrFile, function(data) {
        Object.keys(data[0]).forEach(function(key, index) {
          if (index > 1) {
            line_objects.push({name: key, phenotype: data[0][key], positions: []});
          }
        });

        for (var i=1; i<data.length; i++) {
          Object.keys(data[i]).forEach(function(key, index) {
            if (index > 1) {
              line_objects[index-2].positions.push({pos:data[i].POS, call:data[i][key]});
            }
          });
        }
      console.log(line_objects[0])


      line_objects.sort(function(a, b){
          var x = a.phenotype,
              y = b.phenotype;
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
      console.log(line_objects);

      var W_sep_set = false, S_sep_set = false;

      var vexSVG = d3.select('#variant-explorer').append('svg')
        .attr('float', 'left')
        .attr('width', line_objects[0].positions.length * 10 + 'px')
        .attr('height', line_objects.length * 10 + 'px')
        .attr('position', 'relative')
        .attr('id', 'vex-svg')
        .attr('margin', '0px 0px 0px 0px')
        .attr('padding', '0px 0px 0px 0px')
        .attr('display', 'block')
        .attr('transform', 'matrix(1 0 0 1 0 0)')
        .attr('onload', 'initTooltip(evt)')

      for (var i=0; i<line_objects.length; i++) {
        var y = y0 + i * 6;
        drawgroup = vexSVG.append('g')
          .attr('id', 'vex-svg-' + line_objects[i].name) 
          .data( [ {"x": x0, "y": y} ] )
          //.attr('x', x0)
          //.attr('y', y0)
          //.attr('transform', 'matrix(1 0 0 1 0 0)')
          .attr('transform', 'translate(' + x0 + ',' + y + ')')
          .call(drag)
          .on("mouseover", overNode)
          .on("mouseout", outNode);
       console.log("X:" + drawgroup.x);

        if (line_objects[i].phenotype == 'W') {
          color = '#00f';
          if (!W_sep_set) {
            vexSVG.append('rect')
                .attr('x', x0)
                //.attr('y', y-1)
                .attr('color', '#000')
                .attr('height', 1 + 'px')
                .attr('width', line_objects[0].positions.length * 10);
            W_sep_set = true;
          }
        } else if (line_objects[i].phenotype == 'S') {
          color = '#f00';
          if (!S_sep_set) {
            vexSVG.append('rect')
                .attr('x', x0)
                //.attr('y', y-1)
                .attr('color', '#000')
                .attr('height', 1 + 'px')
                .attr('width', line_objects[0].positions.length * 10);
            S_sep_set = true;
          }
        } else if (line_objects[i].phenotype == 'R') {
          color = '#0f0';
        }

        drawgroup.append('rect')
            .attr('x', x0)
            //.attr('y', y)
            .attr('fill', color)
            .attr('height', 5 + 'px')
            .attr('width', 5 + 'px');

        for (var j=0,x=11; j<line_objects[i].positions.length; j++, x+=6) {
          if (line_objects[i].positions[j].call == 'NA') {
            color = '#fff';
            call = 'NA';
          } else if (line_objects[i].positions[j].call >= 0.9) {
            color = '#cfc';
            call = 'homA';
          } else if (line_objects[i].positions[j].call <= 0.1) {
            color ='#fcc';
            call = 'homR';
          } else { 
            color = '#ffc';
            call = 'het';
          }

          var tt_text = line_objects[i].name + ':' + line_objects[i].phenotype + ':' + line_objects[i].positions[j].pos + ':' + call + ' (af=' + line_objects[i].positions[j].call + ')';
          drawgroup.append('rect')
              .attr('x', x)
              //.attr('y', y)
              .attr('fill', color)
              .attr('height', 5 + 'px')
              .attr('width', 5 + 'px')
              .attr('onmousemove', 'ShowTooltip(evt, "' + tt_text + '",' + x + ',' + y + ')')
              .attr('onmouseout', 'HideTooltip(evt)');

        }

      }

       vexSVG.append('rect')
        .attr('x', 0)
        .attr('y', 0)
        .attr('rx', 4)
        .attr('ry', 4)
        .attr('width', 52)
        .attr('height', 16)
        .attr('class', 'tooltip_bg')
        .attr('id', 'tooltip_bg')
        .attr('visibility', 'hidden');


      vexSVG.append('text')
          .attr('x', 0)
          .attr('y', 0)
          .attr('class', 'tooltip')
          .attr('id', 'tooltip')
          .attr('visibility', 'hidden')
          .text('Tooltip');
      });
  }



  </script>


</head>
<body style="width: 100%; height: 100%;" onload="displayChromosome('data/NRGENE.chr1B.vcf.hom90.afTable.tsv')">
  <form>
    <select name="chrSelect" onload="displayChromosome(this.value)" onchange="displayChromosome(this.value)">
      <option value="data/NRGENE.chr1A.vcf.hom90.afTable.tsv">Chr1A</option>
      <option value="data/NRGENE.chr1B.vcf.hom90.afTable.tsv" selected="true">Chr1B</option>
      <option value="data/NRGENE.chr2A.vcf.hom90.afTable.tsv">Chr2A</option>
      <option value="data/NRGENE.chr2B.vcf.hom90.afTable.tsv">Chr2B</option>
      <option value="data/NRGENE.chr3A.vcf.hom90.afTable.tsv">Chr3A</option>
      <option value="data/NRGENE.chr3B.vcf.hom90.afTable.tsv">Chr3B</option>
      <option value="data/NRGENE.chr4A.vcf.hom90.afTable.tsv">Chr4A</option>
      <option value="data/NRGENE.chr4B.vcf.hom90.afTable.tsv">Chr4B</option>
      <option value="data/NRGENE.chr5A.vcf.hom90.afTable.tsv">Chr5A</option>
      <option value="data/NRGENE.chr5B.vcf.hom90.afTable.tsv">Chr5B</option>
      <option value="data/NRGENE.chr6A.vcf.hom90.afTable.tsv">Chr6A</option>
      <option value="data/NRGENE.chr6B.vcf.hom90.afTable.tsv">Chr6B</option>
      <option value="data/NRGENE.chr7A.vcf.hom90.afTable.tsv">Chr7A</option>
      <option value="data/NRGENE.chr7B.vcf.hom90.afTable.tsv">Chr7B</option>
    </select>
  </form>

<div id="variant-explorer" style="width: 100%; height: 100%; position: relative;"></div>


</body>
</html>
